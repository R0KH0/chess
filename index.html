<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARK-X Chess Tournament</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: white;
            overflow-x: auto; 
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            height: 10px;
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        /* Bracket Logic Styles */
        .bracket-container {
            display: flex;
            flex-direction: row;
            padding: 40px;
            min-width: 1000px; /* Reduced width for 3 rounds */
            justify-content: center;
        }

        .round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 250px;
            margin-right: 40px;
            position: relative;
        }

        .match {
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 8px; 
            margin: 6px 0; 
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            transition: all 0.2s ease;
        }
        
        .match:hover {
            border-color: #64748b;
        }

        .team {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 8px; 
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 2px;
        }

        .team input {
            background: transparent;
            border: none;
            color: #e2e8f0;
            width: 100%;
            font-size: 0.85rem; 
            outline: none;
            font-weight: 500;
        }
        .team input:focus {
            border-bottom: 1px solid #3b82f6;
        }

        .winner-btn {
            opacity: 0;
            color: #4ade80;
            margin-left: 8px;
            transition: opacity 0.2s;
        }

        .team:hover .winner-btn {
            opacity: 1;
        }

        .team.won {
            background-color: rgba(34, 197, 94, 0.2);
            border-left: 3px solid #4ade80;
        }
        .team.won input {
            color: #4ade80;
            font-weight: 700;
        }
        
        /* Connector Lines */
        .round:not(:last-child) .match::after {
            content: '';
            position: absolute;
            right: -20px;
            top: 50%;
            width: 20px;
            height: 2px;
            background-color: #475569;
        }
        .round:not(:first-child) .match::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 50%;
            width: 20px;
            height: 2px;
            background-color: #475569;
        }

        /* Adjusting Match vertical position for LB/GF to make it look like a DE structure */
        .round-0 { padding-top: 100px; }
        .round-1 { margin-top: 150px; } /* Push LB down */
        .round-2 { padding-top: 100px; } 

        /* Champion Section */
        .champion-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-left: 20px;
        }

        .trophy {
            font-size: 3rem;
            color: #fbbf24;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.5));
        }

        .reset-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
        }
    </style>
</head>
<body class="antialiased selection:bg-blue-500 selection:text-white">

    <!-- Header -->
    <div class="fixed top-0 left-0 w-full bg-slate-900/90 backdrop-blur-md border-b border-slate-700 z-40 px-6 py-4 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-blue-400"><i class="fas fa-trophy mr-2"></i>ARK-X Chess Tournament (groundfinal)</h1>
        </div>
        <div class="text-xs text-slate-500 hidden sm:block">
            <span id="status-msg">Auto-saving enabled</span>
        </div>
    </div>

    <!-- Main Bracket Area -->
    <div class="pt-24 pb-20 overflow-x-auto min-h-screen flex items-center justify-center">
        <div id="bracket-root" class="bracket-container">
            <!-- Bracket will be injected here by JS -->
        </div>
    </div>

    <!-- Reset Button -->
    <button onclick="resetTournament()" class="reset-btn bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition transform hover:scale-105 flex items-center gap-2">
        <i class="fas fa-trash-alt"></i> Reset Bracket
    </button>

    <script>
        // Key for local storage - updated to v4 for 3-match structure
        const STORAGE_KEY = 'tournament_bracket_3match_de_v4';
        
        // --- 1. Initial State Setup ---

        function createDefaultData() {
            // R0: WB Final (1 match) - Winner to GF P1, Loser to LB Final P1
            const round0Matches = [{ id: `r0-m0`, p1: "Team A", p2: "Team B", winner: null, type: 'WB Final' }];

            // R1: LB Final (1 match) - P1 is R0 Loser. P2 is pre-seeded Team C. Winner to GF P2, Loser is 3rd/4th
            const round1Matches = [{ id: `r1-m0`, p1: null, p2: "Team C", winner: null, type: 'LB Final' }];

            // R2: Grand Final (1 match) - P1 is R0 Winner. P2 is R1 Winner. Champion is winner.
            const round2Matches = [{ id: `r2-m0`, p1: null, p2: null, winner: null, type: 'Grand Final' }];


            return {
                rounds: [
                    { id: 0, matches: round0Matches, name: "Winners' Bracket Final" },
                    { id: 1, matches: round1Matches, name: "Losers' Bracket Final" },
                    { id: 2, matches: round2Matches, name: "Grand Final" }
                ],
                champion: null
            };
        }

        let bracketData = createDefaultData();

        // --- 2. Persistence and Initialization ---

        function init() {
            loadState();
            renderBracket();
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(bracketData));
            const msg = document.getElementById('status-msg');
            msg.textContent = "Saved to local storage";
            msg.style.color = "#4ade80";
            setTimeout(() => {
                msg.textContent = "Auto-saving enabled";
                msg.style.color = "#64748b";
            }, 1000);
        }

        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                bracketData = JSON.parse(saved);
            } else {
                bracketData = createDefaultData(); 
                saveState();
            }
        }

        function resetTournament() {
            if(confirm("Are you sure you want to reset the 3-match tournament?")) {
                bracketData = createDefaultData();
                saveState();
                renderBracket();
            }
        }

        function updateName(roundIndex, matchIndex, playerSlot, newName) {
            const match = bracketData.rounds[roundIndex].matches[matchIndex];
            
            if (playerSlot === 1) match.p1 = newName;
            else match.p2 = newName;
            
            // Re-propagate if the name of a winner is changed
            if (match.winner === 1 && playerSlot === 1) advanceWinner(roundIndex, matchIndex, 1, false);
            if (match.winner === 2 && playerSlot === 2) advanceWinner(roundIndex, matchIndex, 2, false);

            saveState();
            renderBracket();
        }

        function advanceWinner(roundIndex, matchIndex, playerSlot, toggle = true) {
            const match = bracketData.rounds[roundIndex].matches[matchIndex];
            
            const winnerName = playerSlot === 1 ? match.p1 : match.p2;
            const loserName = playerSlot === 1 ? match.p2 : match.p1;
            
            if (!winnerName) return; 

            // Logic to toggle
            if (toggle && match.winner === playerSlot) {
                match.winner = null;
                updateNextRound(roundIndex, winnerName, null, true); // Clear winner path
                
                // Clear loser path if necessary (WB Final only)
                if (roundIndex === 0) {
                    updateLoserBracket(null);
                }

                saveState();
                renderBracket();
                return;
            }

            // Set winner
            match.winner = playerSlot;
            
            // 1. Advance Winner
            updateNextRound(roundIndex, winnerName, winnerName);

            // 2. Drop Loser to LB (Only for WB Final - R0)
            if (roundIndex === 0) {
                updateLoserBracket(loserName);
            } else if (roundIndex === 2) { // Grand Final
                bracketData.champion = winnerName;
            }

            saveState();
            renderBracket();
        }

        // Handles advancement of the WINNER
        function updateNextRound(currentRoundIndex, sourceName, name, isClear = false) {
            if (currentRoundIndex === 2) return; // Grand Final is the end

            let nextRoundIndex = 2; // Default to Grand Final (R2)
            let nextMatchIndex = 0;
            let nextPlayerSlot;

            if (currentRoundIndex === 0) {
                // WB Final Winner (R0) goes to Grand Final P1 (R2 M0 P1)
                nextPlayerSlot = 1;
            } else if (currentRoundIndex === 1) {
                // LB Final Winner (R1) goes to Grand Final P2 (R2 M0 P2)
                nextPlayerSlot = 2;
            }

            const nextMatch = bracketData.rounds[nextRoundIndex].matches[nextMatchIndex];
            if (!nextMatch) return console.error(`Missing next match R${nextRoundIndex}-M${nextMatchIndex}`);

            if (nextPlayerSlot === 1) nextMatch.p1 = name;
            else nextMatch.p2 = name;

            // If the match in the NEXT round already has a winner, clear subsequent rounds
            if (nextMatch.winner && !isClear) {
                nextMatch.winner = null;
                updateNextRound(nextRoundIndex, sourceName, null, true); 
            }
        }
        
        // Handles demotion of the LOSER from WB Final (R0)
        function updateLoserBracket(loserName) {
            // Loser of R0 (WB Final) goes to R1 M0 P1 (LB Final P1)
            const nextRoundIndex = 1;
            const nextMatchIndex = 0; // LB Final
            const nextPlayerSlot = 1;

            const nextMatch = bracketData.rounds[nextRoundIndex].matches[nextMatchIndex];
            if (!nextMatch) return console.error(`Missing LB match R${nextRoundIndex}-M${nextMatchIndex}`);

            // Update the slot
            nextMatch.p1 = loserName;
            
            // Clear subsequent winners if an entrant changes
            if (nextMatch.winner) {
                nextMatch.winner = null;
                // If we clear R1, we must also clear R2 slot for this path
                updateNextRound(nextRoundIndex, loserName, null, true);
            }
        }

        // --- 3. Rendering ---

        function renderBracket() {
            const container = document.getElementById('bracket-root');
            container.innerHTML = '';

            bracketData.rounds.forEach((round, rIndex) => {
                const roundDiv = document.createElement('div');
                roundDiv.className = `round round-${rIndex}`;
                
                // Round Header
                const header = document.createElement('div');
                header.className = "text-center text-slate-500 text-sm font-bold mb-4 uppercase tracking-wider absolute -top-8 w-full";
                header.innerText = round.name;
                
                // Special styling for LB/GF rounds
                if (rIndex === 1) {
                    header.innerHTML = `<span class="text-red-400"><i class="fas fa-hand-fist mr-1"></i> ${round.name}</span>`;
                }
                if (rIndex === 2) {
                    header.innerHTML = `<span class="text-yellow-400"><i class="fas fa-star mr-1"></i> ${round.name}</span>`;
                }

                roundDiv.appendChild(header);

                round.matches.forEach((match, mIndex) => {
                    const matchDiv = document.createElement('div');
                    matchDiv.className = `match`;
                    matchDiv.title = match.type || ''; 

                    // P1
                    matchDiv.appendChild(createTeamElement(rIndex, mIndex, 1, match.p1, match.winner === 1, true));
                    // P2
                    matchDiv.appendChild(createTeamElement(rIndex, mIndex, 2, match.p2, match.winner === 2, true));

                    roundDiv.appendChild(matchDiv);
                });

                container.appendChild(roundDiv);
            });

            // Render Champion Column
            const champDiv = document.createElement('div');
            champDiv.className = 'champion-container';
            champDiv.innerHTML = `
                <i class="fas fa-crown trophy"></i>
                <div class="text-slate-400 text-sm uppercase tracking-widest mb-2">Champion</div>
                <div class="bg-gradient-to-r from-yellow-600 to-yellow-400 text-slate-900 font-bold px-6 py-3 rounded-lg shadow-lg text-xl min-w-[150px] text-center">
                    ${bracketData.champion || '?'}
                </div>
            `;
            container.appendChild(champDiv);
        }

        function createTeamElement(rIndex, mIndex, slot, name, isWinner, showBtn) {
            const div = document.createElement('div');
            div.className = `team ${isWinner ? 'won' : ''}`;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = name || '';
            input.placeholder = (rIndex === 1 && slot === 1) ? "Loser of WB Final" : "TBD";
            
            // Prevent editing of the Loser slot in the LB Final
            if (rIndex === 1 && slot === 1 && !name) {
                input.readOnly = true;
            } else {
                input.addEventListener('input', (e) => updateName(rIndex, mIndex, slot, e.target.value));
            }
            
            div.appendChild(input);

            if (showBtn && name) {
                const btn = document.createElement('button');
                btn.className = 'winner-btn';
                btn.innerHTML = '<i class="fas fa-check-circle"></i>';
                btn.title = "Mark as Winner / Advance";
                btn.onclick = () => advanceWinner(rIndex, mIndex, slot);
                div.appendChild(btn);
            }

            return div;
        }

        // Start
        init();

    </script>
</body>
</html>